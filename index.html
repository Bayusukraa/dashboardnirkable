<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi Smart Trash Monitoring</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter','Segoe UI',system-ui,sans-serif;background:linear-gradient(135deg,#e8f5e9 0%,#c8e6c9 100%);min-height:100vh;padding:24px}
.container{max-width:1600px;margin:auto}
.header-bar{background:linear-gradient(135deg,#1b5e20 0%,#2e7d32 100%);padding:28px 32px;border-radius:20px;box-shadow:0 10px 40px rgba(27,94,32,.25);margin-bottom:32px;position:relative;overflow:hidden}
.header-bar::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);animation:pulse 15s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:.5}50%{transform:scale(1.1);opacity:.3}}
.header-content{text-align:center;color:white;position:relative;z-index:1}
h1{font-size:2.8em;font-weight:700;margin-bottom:12px;text-shadow:0 4px 12px rgba(0,0,0,.2);letter-spacing:-0.5px}
.close-btn{position:fixed;bottom:32px;left:32px;background:white;border:none;color:#64748b;width:56px;height:56px;border-radius:50%;font-size:1.4em;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:1000}
.close-btn:hover{background:#f1f5f9;color:#334155;transform:translateY(-4px) rotate(90deg);box-shadow:0 12px 32px rgba(0,0,0,.2)}
.connection-status{display:inline-flex;align-items:center;gap:8px;padding:10px 24px;border-radius:24px;font-weight:600;font-size:.95em;color:white;margin-top:12px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.connection-status::before{content:'';width:10px;height:10px;border-radius:50%;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.status-disconnected{background:#d32f2f}.status-disconnected::before{background:#ffcdd2}
.status-connecting{background:#f57c00}.status-connecting::before{background:#ffe0b2}
.status-connected{background:#388e3c}.status-connected::before{background:#c8e6c9}
.stats-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:32px}
.stat-card{background:white;border-radius:16px;padding:28px;box-shadow:0 4px 20px rgba(0,0,0,.08);text-align:center;transition:all .3s;border:2px solid transparent}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.15);border-color:#2e7d32}
.stat-icon{font-size:2em;margin-bottom:12px;display:block}
.stat-value{font-size:3em;font-weight:800;color:#1b5e20;line-height:1;margin-bottom:8px}
.stat-label{font-size:.95em;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.control-panel{background:white;border-radius:20px;padding:28px;box-shadow:0 8px 32px rgba(0,0,0,.1);margin-bottom:32px}
.control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.control-card{background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%);border-radius:16px;padding:24px;border:2px solid #e2e8f0;transition:all .3s}
.control-card:hover{border-color:#2e7d32;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.control-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.control-icon{font-size:1.8em}
.control-title{font-size:1.1em;font-weight:700;color:#1e293b}
.control-subtitle{font-size:.85em;color:#64748b;margin-bottom:16px}
.toggle-container{display:flex;align-items:center;justify-content:space-between;gap:12px}
.toggle-label{font-weight:600;color:#475569;font-size:.95em}
.toggle-switch{position:relative;width:60px;height:32px;cursor:pointer}
.toggle-switch input{display:none}
.toggle-slider{position:absolute;top:0;left:0;right:0;bottom:0;background:#cbd5e1;border-radius:32px;transition:all .3s}
.toggle-slider:before{content:'';position:absolute;height:24px;width:24px;left:4px;bottom:4px;background:white;border-radius:50%;transition:all .3s;box-shadow:0 2px 4px rgba(0,0,0,.2)}
.toggle-switch input:checked+.toggle-slider{background:#4caf50}
.toggle-switch input:checked+.toggle-slider:before{transform:translateX(28px)}
.device-mode-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:20px;font-size:.85em;font-weight:700;margin-top:12px}
.mode-active{background:#e8f5e9;color:#2e7d32}
.mode-sleep{background:#fff3e0;color:#f57c00}
.mode-manual-off{background:#ffebee;color:#c62828}
.main-content{display:grid;grid-template-columns:1.2fr 1fr;gap:24px;margin-bottom:32px}
@media(max-width:1024px){.main-content{grid-template-columns:1fr}}
.map-container,.devices-list{background:white;border-radius:20px;padding:28px;box-shadow:0 8px 32px rgba(0,0,0,.1)}
.section-title{font-size:1.4em;font-weight:700;color:#1b5e20;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.section-title::before{content:'';width:4px;height:28px;background:linear-gradient(180deg,#2e7d32,#66bb6a);border-radius:2px}
#map{height:550px;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.1)}
.devices-scroll{max-height:550px;overflow-y:auto;padding-right:8px}
.devices-scroll::-webkit-scrollbar{width:6px}
.devices-scroll::-webkit-scrollbar-track{background:#f1f5f9;border-radius:3px}
.devices-scroll::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:3px}
.device-card{background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%);border-radius:16px;padding:20px;margin-bottom:16px;border-left:6px solid;box-shadow:0 4px 16px rgba(0,0,0,.06);transition:all .3s}
.device-card:hover{transform:translateX(4px);box-shadow:0 8px 24px rgba(0,0,0,.12)}
.device-kosong{border-color:#4caf50}
.device-hampir{border-color:#ff9800}
.device-penuh{border-color:#f44336}
.device-offline{border-color:#9e9e9e}
.device-sleep{border-color:#ffa726}
.device-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.device-name{font-weight:700;font-size:1.15em;color:#1e293b}
.device-status-badge{padding:6px 16px;border-radius:20px;font-size:.8em;font-weight:700;color:white;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.badge-kosong{background:linear-gradient(135deg,#4caf50,#66bb6a)}
.badge-hampir{background:linear-gradient(135deg,#ff9800,#ffa726)}
.badge-penuh{background:linear-gradient(135deg,#f44336,#e57373)}
.badge-offline{background:linear-gradient(135deg,#9e9e9e,#bdbdbd)}
.badge-sleep{background:linear-gradient(135deg,#ffa726,#ffb74d)}
.progress-mini{width:100%;height:10px;background:#e0e0e0;border-radius:6px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.1)}
.progress-fill{height:100%;transition:width .5s ease}
.timestamp{text-align:center;color:#475569;margin-top:24px;padding:16px;background:white;border-radius:12px;font-weight:600;box-shadow:0 4px 16px rgba(0,0,0,.05)}
@media(max-width:768px){body{padding:16px}h1{font-size:2em}.stats-overview{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}.stat-value{font-size:2.2em}.close-btn{width:48px;height:48px;bottom:20px;left:20px}.control-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<header class="header-bar">
<button class="close-btn" onclick="window.location.href='https://dashboardsamdbal.vercel.app/'">‚úï</button>
<div class="header-content">
<h1>üöÆ Multi Smart Trash Monitoring System</h1>
<div id="connectionStatus" class="connection-status status-disconnected">DISCONNECTED</div>
</div>
</header>

<div class="stats-overview">
<div class="stat-card"><span class="stat-icon">üìä</span><div id="totalDevices" class="stat-value">0</div><div class="stat-label">Total Device</div></div>
<div class="stat-card"><span class="stat-icon">‚úÖ</span><div id="kosongCount" class="stat-value">0</div><div class="stat-label">Kosong</div></div>
<div class="stat-card"><span class="stat-icon">‚ö†Ô∏è</span><div id="hampirCount" class="stat-value">0</div><div class="stat-label">Hampir Penuh</div></div>
<div class="stat-card"><span class="stat-icon">üî¥</span><div id="penuhCount" class="stat-value">0</div><div class="stat-label">Penuh</div></div>
<div class="stat-card"><span class="stat-icon">üì°</span><div id="offlineCount" class="stat-value">0</div><div class="stat-label">Offline/Sleep</div></div>
</div>

<div class="control-panel">
<div class="control-grid">
<div class="control-card">
<div class="control-header">
<span class="control-icon">‚è∞</span>
<div><div class="control-title">Auto Sleep Mode</div><div class="control-subtitle">Otomatis sleep jam 12:00‚Äì18:00</div></div>
</div>
<div class="toggle-container">
<span class="toggle-label">Auto Sleep</span>
<label class="toggle-switch">
<input type="checkbox" id="toggleAutoSleep" checked onchange="toggleAutoSleep()">
<span class="toggle-slider"></span>
</label>
</div>
<div id="autoSleepStatus" class="device-mode-badge mode-active">üü¢ AKTIF</div>
</div>

<div class="control-card">
<div class="control-header">
<span class="control-icon">üò¥</span>
<div><div class="control-title">Sleep Manual</div><div class="control-subtitle">Paksa sleep semua device sekarang</div></div>
</div>
<div class="toggle-container">
<span class="toggle-label">Sleep Sekarang</span>
<label class="toggle-switch">
<input type="checkbox" id="toggleManualSleep" onchange="toggleManualSleep()">
<span class="toggle-slider"></span>
</label>
</div>
<div id="manualSleepStatus" class="device-mode-badge mode-manual-off">üî¥ MATI</div>
</div>
</div>
</div>

<div class="main-content">
<div class="map-container">
<h3 class="section-title">üó∫Ô∏è Peta Lokasi Real-time</h3>
<div id="map"></div>
</div>
<div class="devices-list">
<h3 class="section-title">üìã Status Perangkat</h3>
<div class="devices-scroll" id="devicesList"></div>
</div>
</div>

<div class="timestamp">üïê System Time: <span id="systemTime"></span></div>
</div>

<script>
const devices = [
  {name:"Tong Parkir A", topic:"smarttrash/device1/data", control:"smarttrash/device1/control", lat:-8.6705, lng:115.2126, id:"device1"},
  {name:"Tong Parkir B", topic:"smarttrash/device2/data", control:"smarttrash/device2/control", lat:-8.6712, lng:115.2131, id:"device2"}
];

let devicesData = {};
let autoSleepMode = true;
let manualSleep = false;
let markers = {};
let map;

const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt", {keepalive:60, reconnectPeriod:3000});

function isInSleepTime() {
  const now = new Date();
  const hour = now.getHours();
  return hour >= 12 && hour < 18;
}

function toggleAutoSleep() {
  autoSleepMode = document.getElementById('toggleAutoSleep').checked;
  updateAutoSleepDisplay();
  render();
}

function toggleManualSleep() {
  manualSleep = document.getElementById('toggleManualSleep').checked;
  const status = document.getElementById('manualSleepStatus');
  if (manualSleep) {
    status.className = 'device-mode-badge mode-sleep';
    status.textContent = 'üò¥ SLEEP MANUAL AKTIF';
    devices.forEach(d => client.publish(d.control, "SLEEP"));
  } else {
    status.className = 'device-mode-badge mode-manual-off';
    status.textContent = 'üî¥ MATI';
    devices.forEach(d => client.publish(d.control, "WAKE"));
  }
  render();
}

function updateAutoSleepDisplay() {
  const badge = document.getElementById('autoSleepStatus');
  if (autoSleepMode) {
    badge.className = isInSleepTime() ? 'device-mode-badge mode-sleep' : 'device-mode-badge mode-active';
    badge.textContent = isInSleepTime() ? 'üò¥ SLEEP OTOMATIS' : 'üü¢ AKTIF';
  } else {
    badge.className = 'device-mode-badge mode-manual-off';
    badge.textContent = 'üî¥ NONAKTIF';
  }
}

// Peta
map = L.map("map").setView([-8.6708, 115.2128], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {attribution: '¬© OpenStreetMap'}).addTo(map);
devices.forEach(d => {
  markers[d.topic] = L.circleMarker([d.lat, d.lng], {radius:12, fillColor:"#9e9e9e", color:"#fff", weight:3, fillOpacity:.9})
    .addTo(map)
    .bindPopup(`<strong>${d.name}</strong><br>Status: Menunggu...`);
});

function render() {
  let k=0, h=0, p=0, o=0;
  const list = document.getElementById("devicesList");
  list.innerHTML = "";
  devices.forEach(d => {
    const data = devicesData[d.topic];
    let cls = "device-offline", badge = "badge-offline", text = "OFFLINE", persen = 0;

    const isManualSleep = manualSleep;
    const isAutoSleep = autoSleepMode && isInSleepTime();

    if (isManualSleep) {
      cls = "device-sleep"; badge = "badge-sleep"; text = "SLEEP MANUAL"; o++;
    } else if (isAutoSleep) {
      cls = "device-sleep"; badge = "badge-sleep"; text = "SLEEP AUTO"; o++;
    } else if (data) {
      persen = data.persentase || 0;
      if (data.status === "KOSONG") { cls="device-kosong"; badge="badge-kosong"; text="KOSONG"; k++; }
      else if (data.status === "HAMPIR PENUH") { cls="device-hampir"; badge="badge-hampir"; text="HAMPIR PENUH"; h++; }
      else if (data.status === "PENUH") { cls="device-penuh"; badge="badge-penuh"; text="PENUH"; p++; }
    } else {
      o++;
    }

    const marker = markers[d.topic];
    if (marker) {
      const color = isManualSleep || isAutoSleep ? "#ffa726" : 
                    data && data.status === "KOSONG" ? "#4caf50" : 
                    data && data.status === "HAMPIR PENUH" ? "#ff9800" : "#f44336";
      marker.setStyle({fillColor: color || "#9e9e9e"});
      marker.setPopupContent(`<strong>${d.name}</strong><br>Status: ${text}<br>Jarak: ${data?.jarak || '-'} cm<br>Persentase: ${persen}%`);
    }

    const el = document.createElement("div");
    el.className = `device-card ${cls}`;
    el.innerHTML = `<div class="device-header"><div class="device-name">${d.name}</div><div class="device-status-badge ${badge}">${text}</div></div>
                    <div class="progress-mini"><div class="progress-fill" style="width:${persen}%;background:${persen<30?"#4caf50":persen<70?"#ff9800":"#f44336"}"></div></div>`;
    list.appendChild(el);
  });

  document.getElementById('totalDevices').textContent = devices.length;
  document.getElementById('kosongCount').textContent = k;
  document.getElementById('hampirCount').textContent = h;
  document.getElementById('penuhCount').textContent = p;
  document.getElementById('offlineCount').textContent = o;
}

// MQTT
client.on("connect", () => {
  document.getElementById('connectionStatus').className = "connection-status status-connected";
  document.getElementById('connectionStatus').textContent = "CONNECTED";
  client.subscribe("smarttrash/+/data");
});

client.on("message", (topic, msg) => {
  try {
    const data = JSON.parse(msg.toString());
    devicesData[topic] = data;
    render();
  } catch(e) { console.error(e); }
});

setInterval(() => {
  document.getElementById('systemTime').textContent = new Date().toLocaleString('id-ID');
  updateAutoSleepDisplay();
  render();
}, 1000);

window.addEventListener('load', () => {
  render();
  console.log('Dashboard Smart Trash Real-time siap!');
});
</script>
</body>
</html>
